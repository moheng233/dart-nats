import 'dart:async';
import 'dart:typed_data';

import 'package:dart_nats/dart_nats.dart';
import 'package:test/test.dart';

void main() {
  group('all', () {
    test('simple', () async {
      final client = NatsClient();
      await client.connect(Uri.parse('nats://localhost:4222'), retryInterval: 1);
      final sub = client.sub('subject1');
      await client.pub('subject1', Uint8List.fromList('message1'.codeUnits));
      final msg = await sub.stream.first;
      await client.close();
      expect(String.fromCharCodes(msg.byte), equals('message1'));
    });
    test('respond', () async {
      final server = NatsClient();
      await server.connect(Uri.parse('nats://localhost:4222'));
      final service = server.sub('service');
      service.stream.listen((m) {
        m.respondString('respond');
      });

      final requester = NatsClient();
      await requester.connect(Uri.parse('nats://localhost:4222'));
      final inbox = newInbox();
      final inboxSub = requester.sub(inbox);

      await requester.pubString('service', 'request', replyTo: inbox);

      final receive = await inboxSub.stream.first;

      await requester.close();
      await service.close();
      expect(receive.string, equals('respond'));
    });
    test('request', () async {
      final server = NatsClient();
      await server.connect(Uri.parse('nats://localhost:4222'));
      final service = server.sub('service');
      unawaited(
        service.stream.first.then((m) {
          m.respond(Uint8List.fromList('respond'.codeUnits));
        }),
      );

      final client = NatsClient();
      await client.connect(Uri.parse('nats://localhost:4222'));
      final receive = await client.request(
        'service',
        Uint8List.fromList('request'.codeUnits),
      );

      await client.close();
      await service.close();
      expect(receive.string, equals('respond'));
    });
    test('long message', () async {
      const txt =
          '12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890';
      final client = NatsClient();
      await client.connect(Uri.parse('nats://localhost:4222'), retryInterval: 1);
      final sub = client.sub('subject1');
      await client.pub('subject1', Uint8List.fromList(txt.codeUnits));
      await client.pub('subject1', Uint8List.fromList(txt.codeUnits));
      var msg = await sub.stream.first;
      msg = await sub.stream.first;
      await client.close();
      expect(String.fromCharCodes(msg.byte), equals(txt));
    });
  });
}
